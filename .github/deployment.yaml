# =============================================================================
# Auth Middleware - Kubernetes Deployment
# Covers ALL .env variables via ConfigMap (non-sensitive) + Secret (sensitive)
# =============================================================================

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-middleware-config
  namespace: confuse-platform
data:
  SERVICE_NAME: "auth-middleware"
  PORT: "3010"
  GRPC_PORT: "50058"
  NODE_ENV: "production"
  # Auth0 (non-sensitive)
  AUTH0_DOMAIN: "dev-pmspwseo1uaudyoi.jp.auth0.com"
  AUTH0_ISSUER: "https://dev-pmspwseo1uaudyoi.jp.auth0.com"
  AUTH0_AUDIENCE: "https://api.confuse.dev"
  AUTH0_JWKS_URI: "https://dev-pmspwseo1uaudyoi.jp.auth0.com/.well-known/jwks.json"
  AUTH0_MANAGEMENT_DOMAIN: "dev-pmspwseo1uaudyoi.jp.auth0.com"
  # Token Cache
  TOKEN_CACHE_TTL_SECONDS: "900"
  # Feature Toggle Service
  FEATURE_TOGGLE_SERVICE_URL: "http://feature-toggle:3099"
  # CORS
  CORS_ORIGINS: "https://confuse.platform.example.com"
  # Frontend
  FRONTEND_URL: "https://confuse.platform.example.com"

---
apiVersion: v1
kind: Secret
metadata:
  name: auth-middleware-secrets
  namespace: confuse-platform
type: Opaque
stringData:
  # Database (REQUIRED)
  DATABASE_URL: "CHANGEME_postgresql://user:pass@host:5432/postgres?sslmode=require"
  # Redis (REQUIRED)
  REDIS_URL: "CHANGEME_redis://default:password@host:port"
  # Auth0 Management API (REQUIRED)
  AUTH0_CLIENT_ID: "CHANGEME_AUTH0_M2M_CLIENT_ID"
  AUTH0_CLIENT_SECRET: "CHANGEME_AUTH0_M2M_CLIENT_SECRET"
  # Internal API Key
  INTERNAL_API_KEY: "CHANGEME_INTERNAL_API_KEY"
  # Confluent Cloud (if Kafka events enabled)
  CONFLUENT_API_KEY: "CHANGEME_CONFLUENT_API_KEY"
  CONFLUENT_API_SECRET: "CHANGEME_CONFLUENT_API_SECRET"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-middleware
  namespace: confuse-platform
  labels:
    app: auth-middleware
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: auth-middleware
  template:
    metadata:
      labels:
        app: auth-middleware
        version: v1
    spec:
      imagePullSecrets:
      - name: acr-secret
      containers:
      - name: auth-middleware
        image: "confuseimgr.azurecr.io/auth-middleware:latest"
        imagePullPolicy: Always
        ports:
        - containerPort: 3010
          name: http
        envFrom:
        - configMapRef:
            name: auth-middleware-config
        - secretRef:
            name: auth-middleware-secrets
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
        livenessProbe:
          exec:
            command:
            - wget
            - --no-verbose
            - --tries=1
            - --spider
            - http://localhost:3010/health
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - wget
            - --no-verbose
            - --tries=1
            - --spider
            - http://localhost:3010/health
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

---
apiVersion: v1
kind: Service
metadata:
  name: auth-middleware
  namespace: confuse-platform
spec:
  selector:
    app: auth-middleware
  ports:
  - name: http
    protocol: TCP
    port: 3010
    targetPort: 3010
  type: ClusterIP
